---
title: "Darwin Core mapping of VMM rattenapp data"
author:
- Damiano Oldoni
- Peter Desmet
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
    number_sections: yes
    toc: yes
    toc_depth: 3
    toc_float: yes
---

# Setup 

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = TRUE, message = TRUE)
```

Install required libraries (if not yet installed):

```{r install_pkgs}
installed <- rownames(installed.packages())
required <- c("dplyr", "readr", "purrr", "stringr", "here",
              "glue", "readxl", "DBI", "RSQLite", "digest", "tidylog")
if (!all(required %in% installed)) {
  install.packages(required[!required %in% installed])
}
```

Load libraries:

```{r load_pkgs, message = FALSE}
library(dplyr)          # To transform data
library(tidylog)        # To provide feedback on dplyr functions
library(readr)          # To read and write tabular text files
library(purrr)          # To work with lists
library(stringr)        # To work with strings
library(here)           # To find files
library(glue)           # To insert variables in strings
library(readxl)         # To read Excel files
library(DBI)            # To create and query databases
library(RSQLite)        # To work with SQLite databases
library(digest)         # To generate hashes
```

## Connect to database

Connect to the SQLite database with the occurrence data created in `fetch_data.Rmd`:

```{r create_db}
message("Connect to SQLite database...")
sqlite_path <- here::here("data", "interim", "occurrences.sqlite")
con <- DBI::dbConnect(RSQLite::SQLite(), dbname = sqlite_path)
message("DONE")
```

# Darwin Core mapping

Create [Occurrence](https://rs.gbif.org/core/dwc_occurrence_2022-02-02.xml) extension:

```{r occurrence}
message("Map occurrences to DwC...")
dwc_occurrence_sql <- glue::glue_sql(
  readr::read_file(here::here("sql", "dwc_occurrence.sql")), 
  .con = con)
dwc_occurrence <- DBI::dbGetQuery(con, dwc_occurrence_sql)
message("DONE")
```

# Save data to CSV

```{r save_csv}
readr::write_csv(
  dwc_occurrence,
  here::here("data", "processed", "occurrence.csv"),
  na = ""
)
```

# Overview changes

In this section we summarize the changes in the DwC output after the very last udpate.

## Read DwC files

Read DwC mapping files from both `main`:

```{r main}
dwc_occurrence_main <- readr::read_csv(
  file = "https://raw.githubusercontent.com/riparias/vmm-rattenapp-occurrences/main/data/processed/occurrence.csv",
  col_types = cols(.default = "c"))
```

and actual branch (`automatic-update-*`):
 
```{r automatic-update}
dwc_occurrence_update <- readr::read_csv(
  file = here::here("data","processed","occurrence.csv"),
  col_types = cols(.default = "c"))
```

## Overview

How many new occurrences, i.e. new `occurrenceID` values, have been added?

```{r new_occurrenceID_values}
new_occs <- 
  dwc_occurrence_update %>%
  filter(!.data$occurrenceID %in% dwc_occurrence_main$occurrenceID)
message("New occurrences:")
print(new_occs)
```

Have some occurrences been removed?

```{r removed_occs}
removed_occs <- 
  dwc_occurrence_main %>%
  filter(!.data$occurrenceID %in% dwc_occurrence_update$occurrenceID)
message("Removed occurrences:")
print(removed_occs)
```

Total number of rows of new DwC output in comparison with the previous version:

```{r nrows}
message(paste("Number of occurrences (new):", nrow(dwc_occurrence_update)))
message(paste("Number of occurrences (old):", nrow(dwc_occurrence_main)))
message(paste("Difference:", 
              nrow(dwc_occurrence_update) - nrow(dwc_occurrence_main))
)
```

## New `Sporen Waarnemingen Naam` values

The DwC `scientificName` is a manual mapping of Dutch vernacular names (e.g. `Roerdomp`) or expressions (e.g. `Eendensterfte circa 25 st`) from field `Sporen Waarnemingen Naam`. It is therefore important to get a list with all new values:

```{r new_Sporen_Waarnemingen_Naam}
occs_without_sc_name <- 
  dwc_occurrence_update %>%
  filter(is.na(scientificName)) %>%
  pull(occurrenceID)
query <- glue::glue_sql("
  SELECT 
    DISTINCT o.\"Sporen Waarnemingen Naam\" AS \"SporenWaarnemingenNaam\"
  FROM occurrences AS o 
  WHERE  
  o.\"Registratie ID\" || ':' || o.\"species_name_hash\" IN ({occs_without_sc_name*})
  ", .con = con)
query
raw_sc_names <- dplyr::as_tibble(DBI::dbGetQuery(con, query))
message("New values in field 'Sporen Waarnemingen Naam' to be mapped:")
raw_sc_names
```
